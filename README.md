# ML Fraud Detection Service

DISCLAIMER

Сервис подготовлен в рамках ДЗ 1 по MLOps в ШАД МТС 2025.
Датасеты представлены в соревновании https://www.kaggle.com/competitions/teta-ml-1-2025

Сервис для автоматического обнаружения мошеннических транзакций в режиме батчевого скоринга. Обрабатывает CSV-файлы из указанной директории с использованием предобученной CatBoost модели. 

## Архитектура решения
```
├── .gitignore
├── Dockerfile
├── README.md
├── app/
| ├── __init__.py
│ └── app.py # Ядро сервиса с обработчиком файлов
├── models/
│ └── model_catboost.cbm # Сериализованная модель CatBoost
├── src/
| ├── __init__.py
│ ├── preprocessing.py # Пайплайн обработки данных
│ └── scorer.py # Модуль прогнозирования
└── train_data/
│ └── train.csv # Данные для обучения (reference), необходимо скачать из соревнования
└── input/ # Директория для загрузки файлов на скоринг
└── output/ # Директория с результатами скоринга
```

## Ключевые особенности

### Многоуровневое логирование
- Регистрация всех событий в файл `/app/logs/service.log`
- Консольный вывод логов для мониторинга в реальном времени
- 3 уровня детализации:
  - `INFO`: Основные этапы обработки
  - `DEBUG`: Детали преобразования данных
  - `ERROR`: Критические сбои с трейсбэками

### Пайплайн обработки данных (`preprocessing.py`)
1. #### Временные признаки:
- Извлечение часа, дня, месяца, года, дня недели из `transaction_time`
- Удаление исходного `transaction_time`

2. #### Геопространственные расчёты:
- Расчёт евклидова расстояния между координатами клиента и мерчанта
- Логарифмирование расстояния

3. #### Контекстные признаки:
- Флаг транзакции ночью `is_night`
- Флаг выходного дня `is_weekend`
- Объединение имени `name_full` 
- Объединение региона продавца `merchant_region` из `lat` и `lon`

4. #### Категориальные переменные:
- Переименование признаков с добавлением суффикса _cat
- Индексация категориальных признаков для CatBoost

5. #### Числовые признаки:
- Заполнение пропусков средними значениями
- Логарифмирование (log1p) числовых фичей
- Добавление бинарного флага `is_large_transaction` (по медиане суммы)

### Модельный слой (`scorer.py`)
- Порог классификации: 0.95
- Автоматическая загрузка модели при инициализации
- Батчевая обработка через `predict_proba`
- Аналитика признаков `save_feature_importance_json`:
- - Получение важности признаков модели
- - Сохранение top-5 признаков в JSON
- Визуализация `save_prediction_density_plot`:
- - Гистограмма предсказанных вероятностей
- - Сохранение графика в PNG


## Быстрый старт

### Требования
- Docker 20.10+
- 2 ГБ свободного места
- Порты: только файловая система

### Запуск сервиса

1. Скачайте файл `train.csv` из соревнования https://www.kaggle.com/competitions/teta-ml-1-2025 и разместите в директории `./train_data`
2. Соберите образ
```bash
docker build -t fraud_detector .
```
3. Запустите контейнер с монтированием томов
```bash
docker run -it --rm -v ./input:/app/input \
                    -v ./output:/app/output \
                    fraud_detector
```
! Если работаете на Windows, то надо указать абсолютные пути к томам,
т.к. Docker работает с WSL и прокидывать файлы в контейнер тяжело. 
Например:
```ps
docker run -it --rm -v C:/reps/mts25_mlops_hw1/input:/app/input -v C:/reps/mts25_mlops_hw1/output:/app/output fraud_detector
```
4. После запуска сервиса (появления в логах сообщения: `__main__ - INFO - File observer started`) можно приступать к скорингу данных:
 - Разместите файл формата test.csv из соревнования https://www.kaggle.com/competitions/teta-ml-1-2025 в директории `./input`
 - Подождите выполнения препроцессинга и скоринга датасета (в логах будет указано название сформированного файла)
 - Полученный результат моделирования, топ-5 feature importances и распределение предсказаний будет выгружен сервисом в директорию `./output`
